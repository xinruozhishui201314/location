# 融合定位系统架构设计文档

## 系统概述

本系统融合了FAST-LIVO2的前端处理能力和LIO-SAM的后端优化框架，结合多种传感器和定位方式，实现高性能的全局定位。

## 架构设计

### 1. 系统层次结构

```
┌─────────────────────────────────────────────────┐
│           传感器数据输入层                        │
│  (LiDAR, IMU, Camera, GPS/RTK)                  │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│           数据同步与预处理层                      │
│  (时间同步, 数据缓冲, 点云滤波)                   │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│           快速初始化模块                          │
│  (GPS/RTK → 二维码 → 先验地图 → 运动初始化)       │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│           前端处理层 (FAST-LIVO2风格)            │
│  - 直接法里程计估计                               │
│  - 实时状态更新                                   │
│  - 关键帧选择                                     │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│           后端优化层 (LIO-SAM风格)               │
│  - 因子图构建 (GTSAM)                            │
│  - 多源约束融合                                   │
│  - 全局优化                                       │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│           高频输出层 (100Hz)                     │
│  - 状态插值                                       │
│  - 消息发布                                       │
└─────────────────────────────────────────────────┘
```

### 2. 核心模块详解

#### 2.1 快速初始化模块

**设计目标**：在GPS信号不佳时，快速准确地完成系统初始化。

**初始化策略优先级**：
1. **RTK定位**（最高优先级）
   - 精度：厘米级
   - 条件：RTK信号可用
   - 时间：< 1秒

2. **GPS定位**
   - 精度：米级
   - 条件：GPS信号良好（协方差 < 阈值）
   - 时间：< 2秒

3. **二维码定位**
   - 精度：厘米级（2-5cm）
   - 条件：可见已注册的二维码
   - 时间：< 1秒
   - **适用场景**：充电站、加水站等关键区域

4. **先验地图匹配**
   - 精度：分米级
   - 条件：先验地图已加载
   - 方法：NDT点云配准
   - 时间：2-5秒

5. **运动初始化**
   - 精度：较低
   - 条件：需要短距离运动
   - 方法：基于IMU和LiDAR的短时里程计
   - 时间：5-10秒

#### 2.2 前端处理模块（FAST-LIVO2风格）

**核心思想**：直接法处理，避免特征提取，提高实时性。

**处理流程**：
1. 点云预处理（去畸变、下采样）
2. 直接法里程计估计（ICP/NDT）
3. 状态传播（结合IMU）
4. 关键帧判断

**优势**：
- 计算速度快
- 对特征缺失场景鲁棒
- 实时性好

#### 2.3 后端优化模块（LIO-SAM风格）

**核心思想**：因子图优化，全局一致性。

**因子类型**：

1. **里程计因子** (BetweenFactor)
   - 来源：前端里程计估计
   - 噪声模型：对角高斯
   - 权重：中等

2. **GPS/RTK因子** (GPSFactor)
   - 来源：GPS/RTK接收机
   - 噪声模型：根据协方差自适应
   - 权重：GPS中等，RTK高

3. **二维码因子** (PriorFactor)
   - 来源：二维码检测
   - 噪声模型：高精度（厘米级）
   - 权重：很高
   - **关键应用**：充电/加水站精确定位

4. **先验地图因子** (PriorFactor)
   - 来源：先验地图匹配
   - 噪声模型：根据匹配质量自适应
   - 权重：中等

5. **回环因子** (BetweenFactor, 可选)
   - 来源：回环检测
   - 噪声模型：根据匹配分数
   - 权重：高

**优化框架**：
- 使用GTSAM的ISAM2进行增量优化
- 支持实时优化和批量优化
- 自动管理因子图规模

#### 2.4 二维码定位模块

**技术方案**：
- 使用ArUco标记（OpenCV）
- 支持多种字典（DICT_6X6_250等）
- 6DOF位姿估计

**精度分析**：
- **理论精度**：2-5cm（取决于二维码尺寸和相机分辨率）
- **实际精度**：3-10cm（考虑检测误差和标定误差）
- **适用距离**：0.5-5米（取决于二维码尺寸）

**性能评估**：
- **检测速度**：< 50ms（640x480图像）
- **识别率**：> 95%（良好光照条件）
- **鲁棒性**：对部分遮挡和光照变化有一定鲁棒性

**应用场景**：
- 充电站精确定位（要求：±5cm）
- 加水站精确定位（要求：±10cm）
- 关键操作点定位

**限制因素**：
- 需要良好的光照条件
- 二维码不能被完全遮挡
- 需要已知二维码位置数据库

#### 2.5 高频输出模块

**设计**：
- 使用ROS2定时器实现100Hz输出
- 对当前状态进行插值
- 发布里程计和路径消息

**状态插值**：
- 基于最新优化结果
- 结合IMU数据进行短时预测
- 保证输出的连续性和平滑性

### 3. 数据流设计

```
传感器数据 → 缓冲区 → 同步 → 前端处理 → 关键帧判断
                                              ↓
                                        后端优化 ← 多源约束
                                              ↓
                                        状态更新 → 高频输出
```

### 4. 关键参数配置

#### 4.1 初始化参数
- `init_timeout`: 初始化超时时间（默认10秒）
- `gps_cov_threshold`: GPS协方差阈值（默认2.0）

#### 4.2 关键帧参数
- `keyframe_distance_threshold`: 距离阈值（默认1.0米）
- `keyframe_angle_threshold`: 角度阈值（默认0.2弧度）
- `max_keyframe_num`: 最大关键帧数（默认100）

#### 4.3 优化参数
- GTSAM ISAM2参数
- 各因子噪声模型参数

### 5. 性能指标

#### 5.1 实时性
- 前端处理：< 50ms
- 后端优化：< 100ms（单次）
- 总延迟：< 150ms
- 输出频率：100Hz（10ms周期）

#### 5.2 精度
- 正常定位：分米级（10-30cm）
- GPS辅助：米级（1-3m）
- RTK辅助：厘米级（2-5cm）
- 二维码辅助：厘米级（2-5cm）

#### 5.3 鲁棒性
- GPS失效：可继续工作（使用里程计和地图）
- 视觉失效：可继续工作（纯LiDAR-IMU）
- 初始化成功率：> 95%（有GPS或二维码）

### 6. 融合策略总结

**FAST-LIVO2前端优势**：
- 直接法，计算快
- 融合视觉，鲁棒性好
- 实时性强

**LIO-SAM后端优势**：
- 因子图优化，全局一致
- 支持多种约束
- 回环检测

**融合方案**：
1. 前端使用FAST-LIVO2的直接法快速估计
2. 后端使用LIO-SAM的因子图框架优化
3. 多源约束融合（GPS、二维码、地图）
4. 高频输出保证实时性

### 7. 未来改进方向

1. **更精确的二维码位姿估计**
   - 使用PnP算法
   - 考虑相机畸变
   - 多二维码融合

2. **更智能的初始化**
   - 多假设初始化
   - 初始化质量评估
   - 自适应初始化策略

3. **性能优化**
   - 并行处理
   - GPU加速
   - 算法优化

4. **更多传感器支持**
   - 轮速计
   - 磁力计
   - 其他定位源

